<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Mouse AHK - v5.9</title>
<style>
:root { 
    --primary: #3793ff; --bg: #121212; --card: #1e1e1e; 
    --text: #e0e0e0; --border: #333; --input-bg: #2d2d2d; 
}
body { font-family: 'Segoe UI', system-ui, sans-serif; margin: 24px; background: var(--bg); color: var(--text); line-height: 1.5; padding-bottom: 120px; }
.context { background: var(--card); border-radius: 12px; padding: 20px; margin-bottom: 24px; box-shadow: 0 8px 16px rgba(0,0,0,0.4); border: 1px solid var(--border); }
.header { display: flex; gap: 12px; align-items: center; margin-bottom: 16px; border-bottom: 1px solid var(--border); padding-bottom: 12px; }
.tag-container { display: flex; gap: 8px; flex-wrap: wrap; }
.tag { background: #1a3a5a; color: var(--primary); padding: 4px 12px; border-radius: 16px; font-size: 0.85rem; display: flex; align-items: center; gap: 8px; border: 1px solid var(--primary); }
.tag.desktop { background: #2e7d32; color: #dff0d8; border-color: #2e7d32; }
.tag.global { background: #444; color: #ccc; border-color: #555; }
table { width: 100%; border-collapse: collapse; }
th { text-align: left; font-size: 0.75rem; color: #888; padding: 8px; }
td { padding: 8px; vertical-align: top; border-bottom: 1px solid var(--border); }
button { padding: 5px 12px; border-radius: 6px; border: 1px solid var(--border); background: #333; color: white; cursor: pointer; transition: 0.1s; }
button:hover { background: #444; }
.btn-main { background: var(--primary); color: white; border: none; font-weight: 600; padding: 8px 16px; }
.btn-add { color: var(--primary); border-color: var(--primary); background: transparent; margin-top: 5px; font-size: 0.75rem; }
select, input { padding: 6px; border-radius: 6px; border: 1px solid var(--border); background: var(--input-bg); color: white; }
.rec-input { width: 90px; font-weight: bold; color: #ff5252; text-align: center; }
.mod-pill { margin: 2px; font-size: 0.8rem; border: 1px solid #444; opacity: 0.6; }
.mod-pill.active { opacity: 1; border-color: var(--primary); background: #1a3a5a; color: var(--primary); font-weight: bold; }
.builder-container { background: #161616; padding: 8px; border-radius: 8px; margin-top: 5px; border-left: 3px solid var(--primary); }
.builder-step { display: flex; align-items: center; gap: 6px; margin-bottom: 4px; }
.gesture-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; background: #181818; padding: 12px; border-radius: 8px; border: 1px solid var(--border); }
.toolbar { position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%); background: #252525; padding: 12px 24px; border-radius: 50px; display: flex; gap: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.5); z-index: 100; border: 1px solid #444; }
.app-input { display: inline-flex; gap: 6px; align-items: center; }
.app-input input { min-width: 200px; }
.small-muted { font-size: 0.8rem; color: #9aa; margin-left: 8px; }
</style>
</head>
<body>
<h1>Mouse AHK Configurator <small style="font-size: 0.5em; color: #666;">v5.9</small></h1>

<div id="contexts-container"></div>

<div class="toolbar">
    <button class="btn-main" onclick="addContext(false)">+ App Context</button>
    <button onclick="addContext(true)">üåê Global Context</button>
    <button class="btn-main" style="background:#2e7d32" onclick="exportAHK()">üíæ Export .ahk</button>
    <button onclick="document.getElementById('fileInput').click()">üìÇ Load .ahk</button>
    <input type="file" id="fileInput" hidden accept=".ahk" onchange="handleImport(this)">
</div>

<script>
/* ---------------------------
   CONFIG
   --------------------------- */
const CONFIG = {
    inputs: ["Back", "Forward", "Middle", "WheelUp", "WheelDown", "WheelLeft", "WheelRight", "Custom"],
    modifiers: ["Ctrl", "Alt", "Shift", "Win", "Middle Held"],
    actions: ["None", "Shortcut", "Macro", "Copy", "Paste", "Cut", "Undo", "Redo", "VolUp", "VolDown", "Mute"],
    ahkMap: { "Copy": "^c", "Paste": "^v", "Cut": "^x", "Undo": "^z", "Redo": "^y", "VolUp": "{Volume_Up}", "VolDown": "{Volume_Down}", "Mute": "{Volume_Mute}" },
    mouseMap: { "Back": "XButton1", "Forward": "XButton2", "Middle": "MButton" },
    modSymbols: { "Ctrl": "^", "Alt": "!", "Shift": "+", "Win": "#" },
    keyMap: { "ArrowLeft": "Left", "ArrowRight": "Right", "ArrowUp": "Up", "ArrowDown": "Down", "Control": "Ctrl", "Meta": "Win", "Escape": "Esc", " ": "Space" }
};

const container = document.getElementById('contexts-container');

/* ---------------------------
   Helper UI builders
   --------------------------- */
function createRecorder(val = "") {
    const wrap = document.createElement('div'); wrap.className = 'rec-box';
    const i = document.createElement('input'); i.className = 'rec-input'; i.value = val;
    i.oninput = save;
    const btnRec = document.createElement('button'); btnRec.textContent = "‚è∫";
    btnRec.onclick = () => {
        i.value = "...";
        const handler = (e) => {
            e.preventDefault();
            let k = CONFIG.keyMap[e.key] || e.key;
            i.value = k; window.removeEventListener('keydown', handler); save();
        };
        window.addEventListener('keydown', handler);
    };
    wrap.append(i, btnRec); return { wrap, input: i };
}

function createModifierUI(savedMods = []) {
    const wrap = document.createElement('div');
    CONFIG.modifiers.forEach(m => {
        const btnMod = document.createElement('button');
        btnMod.className = "mod-pill" + (savedMods.includes(m) ? " active" : "");
        btnMod.textContent = m;
        btnMod.onclick = () => { btnMod.classList.toggle('active'); save(); };
        wrap.appendChild(btnMod);
    });
    return wrap;
}

function createActionInterface(data = null) {
    const mainWrap = document.createElement('div');
    const typeSel = createSelect(CONFIG.actions, data?.type || "None");
    const uiBox = document.createElement('div');
    const renderUI = () => {
        uiBox.innerHTML = "";
        if (typeSel.value === "Shortcut" || typeSel.value === "Macro") {
            const bWrap = document.createElement('div'); bWrap.className = 'builder-container';
            const sList = document.createElement('div');
            const addS = (sd = null) => {
                const step = document.createElement('div'); step.className = 'builder-step';
                const rec = createRecorder(sd?.key || ""); step.append(rec.wrap);
                if (typeSel.value === "Macro") {
                    const d = document.createElement('input'); d.type="number"; d.style.width="55px";
                    d.value = sd?.delay || "50"; d.oninput = save;
                    step.append(document.createTextNode("wait"), d, document.createTextNode("ms"));
                }
                const rem = document.createElement('button'); rem.textContent = "√ó";
                rem.onclick = () => { step.remove(); save(); };
                step.append(rem); sList.appendChild(step);
            };
            const bAdd = document.createElement('button'); bAdd.className="btn-add";
            bAdd.textContent = typeSel.value === "Shortcut" ? "+ Key" : "+ Step";
            bAdd.onclick = () => { addS(); save(); };
            bWrap.append(sList, bAdd); uiBox.appendChild(bWrap);
            if(data?.steps) data.steps.forEach(s => addS(s)); else addS();
        }
    };
    typeSel.onchange = () => { renderUI(); save(); };
    mainWrap.append(typeSel, uiBox); renderUI(); return mainWrap;
}

/* ---------------------------
   Contexts / Rows
   --------------------------- */
function addContext(isGlobal, data = null) {
    // Prevent multiple global contexts
    if (isGlobal && [...document.querySelectorAll('.context')].some(c => c.dataset.global === "true")) {
        alert("A Global context already exists.");
        return;
    }

    const ctx = document.createElement('div'); ctx.className = 'context';
    ctx.dataset.global = !!isGlobal;

    const header = document.createElement('div'); header.className = 'header';
    const tBox = document.createElement('div'); tBox.className = 'tag-container';

    if (!isGlobal) {
        // App input + datalist + URL-aware
        const wrap = document.createElement('div'); wrap.className = 'app-input';
        const inp = document.createElement('input');
        inp.placeholder = "Add app (exe or URL pattern)";
        inp.setAttribute('list', 'commonApps');
        inp.onkeydown = (e) => { if (e.key === 'Enter') { e.preventDefault(); addApp(); } };
        const dl = document.createElement('datalist'); dl.id = 'commonApps';
        const common = [
            'chrome.exe','firefox.exe','msedge.exe','explorer.exe','code.exe',
            'notepad.exe','spotify.exe','vlc.exe'
        ];
        common.forEach(a => { const op = document.createElement('option'); op.value = a; dl.appendChild(op); });
        const addBtn = document.createElement('button'); addBtn.textContent = "Add"; addBtn.onclick = addApp;
        wrap.append(inp, dl, addBtn); header.appendChild(wrap);

        function addApp() {
            const val = inp.value?.trim(); if(!val) return;
            renderTag(val, tBox); inp.value = ""; save();
        }
    } else {
        tBox.innerHTML = `<span class="tag global">GLOBAL FALLBACK</span>`;
    }

    const dBtn = btn("Delete Context", () => { if(confirm("Delete?")) {ctx.remove(); save();} });
    dBtn.style.marginLeft="auto";
    header.append(tBox, dBtn);

    const tbl = document.createElement('table');
    tbl.innerHTML = `<thead><tr><th style="width:20%">Trigger</th><th style="width:25%">Modifiers</th><th style="width:5%">Gest</th><th>Action</th><th style="width:5%"></th></tr></thead><tbody></tbody>`;
    ctx.append(header, tbl, btn("+ Add Row", () => addRow(tbl.querySelector('tbody'))));
    container.appendChild(ctx);

    if (data) {
        if (data.progs?.length) data.progs.forEach(p => renderTag(p, tBox));
        data.rows?.forEach(r => addRow(tbl.querySelector('tbody'), r));
    }
    save();
}

function addRow(tbody, data = null) {
    const tr = document.createElement('tr');
    const recIn = createRecorder(data?.customIn || "");
    const selIn = createSelect(CONFIG.inputs, data?.input);
    recIn.wrap.style.display = data?.input === "Custom" ? "flex" : 'none';
    selIn.onchange = () => { recIn.wrap.style.display = selIn.value === "Custom" ? "flex" : 'none'; save(); };
    const modUI = createModifierUI(data?.mods || []);
    const selGest = createSelect(["No", "Yes"], data?.isGest);
    const mainAct = createActionInterface(data?.mainAction);
    const gGrid = document.createElement('div'); gGrid.className = 'gesture-grid';
    gGrid.style.display = data?.isGest === "Yes" ? 'grid' : 'none';
    ["Up", "Down", "Left", "Right"].forEach((d,i) => {
        const w = document.createElement('div'); w.innerHTML = `<small><b>${d}</b></small>`;
        w.appendChild(createActionInterface(data?.gestures?.[d])); gGrid.appendChild(w);
    });
    selGest.onchange = () => {
        gGrid.style.display = selGest.value === "Yes" ? 'grid' : 'none';
        mainAct.style.display = selGest.value === "Yes" ? 'none' : 'block';
        save();
    };
    const tTd = document.createElement('td'); tTd.append(selIn, recIn.wrap);
    const aTd = document.createElement('td'); aTd.append(mainAct, gGrid);
    tr.append(tTd, td(modUI), td(selGest), aTd, td(btn("√ó", () => {tr.remove(); save();})));
    tbody.appendChild(tr);
    save();
}

/* ---------------------------
   Save / Export / Import
   --------------------------- */
function save() {
    const state = [...document.querySelectorAll('.context')].map(ctx => ({
        isGlobal: ctx.dataset.global === "true",
        progs: [...ctx.querySelectorAll('.tag span')].map(s => s.textContent),
        rows: [...ctx.querySelectorAll('tbody tr')].map(tr => ({
            input: tr.querySelector('td:nth-child(1) select').value,
            customIn: tr.querySelector('td:nth-child(1) .rec-input').value,
            mods: [...tr.querySelectorAll('.mod-pill.active')].map(b => b.textContent),
            isGest: tr.querySelector('td:nth-child(3) select').value,
            mainAction: getActionState(tr.querySelector('td:nth-child(4) > div:first-child')),
            gestures: Object.fromEntries(["Up","Down","Left","Right"].map((d, i) => [d, getActionState(tr.querySelectorAll('.gesture-grid > div')[i])]))
        }))
    }));
    localStorage.setItem('ahk_mouse_v5_9', JSON.stringify(state));
    return state;
}

function getActionState(el) {
    const type = el.querySelector('select').value;
    const steps = [...el.querySelectorAll('.builder-step')].map(s => ({
        key: s.querySelector('input.rec-input').value,
        delay: s.querySelector('input[type="number"]')?.value || "0"
    }));
    return { type, steps };
}

/* ---------------------------
   UI helpers
   --------------------------- */
function handleImport(inp) {
    const r = new FileReader();
    r.onload = () => {
        const m = r.result.match(/; CONFIG_DATA: (.*)/);
        if (m) {
            container.innerHTML = "";
            try { JSON.parse(m[1]).forEach(c => addContext(c.isGlobal, c)); save(); }
            catch(e){ alert("Failed to parse config data."); }
        } else { alert("No CONFIG_DATA found in file."); }
    };
    r.readAsText(inp.files[0]);
}

function renderTag(n, b) {
    const s = document.createElement('div'); s.className = 'tag';
    s.innerHTML = `<span>${n}</span>`;
    const d = document.createElement('b'); d.innerHTML = ' &times;'; d.onclick = () => { s.remove(); save(); };
    s.append(d); b.append(s); save();
}

function createSelect(opts, sel) {
    const s = document.createElement('select');
    opts.forEach(o => { const op = document.createElement('option'); op.value = op.text = o; if(o===sel) op.selected=true; s.add(op); });
    return s;
}

function btn(t,f){const b=document.createElement('button');b.textContent=t;b.onclick=f;return b;}
function td(e){const c=document.createElement('td');c.append(e);return c;}

window.onload = () => {
    const s = localStorage.getItem('ahk_mouse_v5_9');
    if (s) JSON.parse(s).forEach(c => addContext(c.isGlobal, c));
};
</script>
</body>
</html>
